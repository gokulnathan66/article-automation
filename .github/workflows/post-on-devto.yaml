name: Post on Dev.to

on:
  push:
    branches:
      - main

jobs:
  post-on-devto:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '24'

      - name: Install dependencies
        run: npm install

      - name: Run post script and set env variables
        run: |
          # Run Node.js script, output JSON metadata to a temp file
          node api/post.js > post_output.json

          # Export fields from output as environment variables
          echo "SAVED_POST_ID=$(jq -r '.id' post_output.json)" >> $GITHUB_ENV
          echo "SAVED_POST_TITLE=$(jq -r '.title' post_output.json)" >> $GITHUB_ENV
          echo "SAVED_POST_URL=$(jq -r '.url' post_output.json)" >> $GITHUB_ENV
          echo "SAVED_POST_PUBLISHED_AT=$(jq -r '.published_at' post_output.json)" >> $GITHUB_ENV
          echo "SAVED_POST_UPDATED_AT=$(jq -r '.updated_at' post_output.json)" >> $GITHUB_ENV
        env:
          DEV_TO_API_KEY: ${{ secrets.DEV_TO_API_KEY }}

      - name: Show post info
        run: |
          echo "Article posted/updated."
          echo "ID: $SAVED_POST_ID"
          echo "Title: $SAVED_POST_TITLE"
          echo "URL: $SAVED_POST_URL"
          echo "Published At: $SAVED_POST_PUBLISHED_AT"
          echo "Updated At: $SAVED_POST_UPDATED_AT"
